<html>
<head><title>Tic Tac Toe</title>
</head>

<body>
<div id="app"></div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">

var ttt = function(){
  var api = {};

  /* utils */
  Array.prototype.clone = function(){
    return Array.apply(null,this)
  };
  Array.prototype.sorted = function(){
    var tmp = this.clone();
    return tmp.sort.apply(tmp,arguments)
  }
  Array.prototype.reversed = function(){
    var tmp = this.clone();
    return tmp.reverse.apply(tmp,arguments)
  }

  function divmod(num, div){ return [Math.floor(num/div), num%div];}
  api.divmod = divmod;

  function random_color(format){
    var rint = Math.round(0xffffff * Math.random());
    switch(format){
      case 'hex':
        return ('#0' + rint.toString(16)).replace(/^#0([0-9a-f]{6})$/i, '#$1');
        break;
  
      case 'rgb':
        return 'rgb(' + (rint >> 16) + ',' + (rint >> 8 & 255) + ',' + (rint & 255) + ')';
        break;
  
      default:
        return rint;
        break;
    }
  }
  api.random_color = random_color;

  function Cell(row, col) {
    this.row = row;
    this.col = col;
  }
  api.Cell = Cell;
  
  function CanvasGrid(){}
  CanvasGrid.prototype.getCursorPosition = function(e){
    var x;
    var y;
    if (e.pageX != undefined && e.pageY != undefined) {
      x = e.pageX;
      y = e.pageY;
    }
    else {
        x = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
      y = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
    }
    x -= e.currentTarget.offsetLeft;
    y -= e.currentTarget.offsetTop;
    x = Math.min(x, this.BoardWidth * this.PieceWidth);
    y = Math.min(y, this.BoardHeight * this.PieceHeight);
    var cell = new Cell(Math.floor(y/this.PieceHeight), Math.floor(x/this.PieceWidth));
    return cell;
  }
  CanvasGrid.prototype.__init__ = function(selector, options) {
    options = options || {};
    if (typeof options == 'object') {
      options = $.extend(this.defaultOptions, options);
    } else {
      options = this.defaultOptions;
    }
    this.options = options;
    this.canvas = $(selector)[0];
    var ctx = this.canvas.getContext('2d');
    this.ctx = ctx;
    this.ctx.strokeStyle = this.options["strokeStyle"];
    this.BoardWidth = this.options["BoardWidth"];
    this.BoardHeight = this.options["BoardHeight"];
    this.PieceWidth = this.options["PieceWidth"];
    this.PieceHeight = this.options["PieceHeight"];
    this.PixelWidth = this.PieceWidth * this.BoardWidth + 1;
    this.PixelHeight = this.PieceHeight * this.BoardHeight + 1;
    this.canvas.width = this.PixelWidth;
    this.canvas.height = this.PixelHeight;
  }

  TicTacToe.prototype = new CanvasGrid;
  TicTacToe.prototype.constructor = TicTacToe;
  TicTacToe.prototype.defaultOptions = {
    "BoardWidth": 3,
    "BoardHeight": 3,
    "PieceWidth": 100,
    "PieceHeight": 100,
    "player": "X"
  };
  function TicTacToe(selector, options){
    var self = this;
    self.__init__(selector, options);

    function init(){
      self.$gofirst = $('<button id="youGo" value="You Go First">You Go First</button>');
      $('body').append(self.$gofirst);
      self.$gofirst.click(function(e){
        $(e.currentTarget).hide();
        self.move();
        return false;
      });
      self.$restart = $('<button id="restart" value="Restart">Restart</button>');
      $('body').append(self.$restart);
      self.$restart.click(function(e){
        self.restart();
      });
      $(self.canvas).click(self.click);

      self.player = self.options.player;
      self.computer = self.player === "X" ? "O" : "X";
      self.restart();
    }
    this.init = init;

    function restart(){
      self.pieces = ["", "", "", "", "", "", "", "", ""];
      self.$restart.hide();
      self.$gofirst.show();
      self.draw();
      self.thinking = false;
      self.game_over = false;
    }
    this.restart = restart;

    function draw(){
      this.ctx.clearRect(0, 0, self.PixelWidth, self.PixelHeight);
      this.ctx.beginPath();
      this.ctx.strokeStyle = random_color('hex');
      this.ctx.lineWidth = 2;
      this.ctx.moveTo(self.PieceWidth, 0);
      this.ctx.lineTo(self.PieceWidth, self.PixelHeight);
      this.ctx.moveTo(self.PieceWidth * 2, 0);
      this.ctx.lineTo(self.PieceWidth * 2, self.PixelHeight);
      this.ctx.moveTo(0, self.PieceHeight);
      this.ctx.lineTo(self.PixelWidth, self.PieceHeight);
      this.ctx.moveTo(0, self.PieceHeight * 2);
      this.ctx.lineTo(self.PixelWidth, self.PieceHeight * 2);
      this.ctx.stroke();
      this.ctx.closePath();

      for (var i=0; i<9; i++){
        var dm = divmod(i,3);
        var cell = new Cell(dm[0], dm[1]);
        if (this.pieces[i] === 'X'){
          this.putX(cell);
        }
        if (this.pieces[i] === 'O'){
          this.putO(cell);
        }
      }
    }
    self.draw = draw;

    function putX(cell) {
      //console.log('putX', cell);
      this.pieces[cell.col + cell.row*3] = "X";
      this.ctx.beginPath();
      this.ctx.strokeStyle = random_color('hex');
      this.ctx.lineWidth   = 4;
      var offsetX = this.PieceWidth * 0.1;
      var offsetY = this.PieceHeight * 0.1;
      var beginX = cell.col * this.PieceWidth + offsetX;
      var beginY = cell.row * this.PieceHeight + offsetY;
      var endX = (cell.col + 1) * this.PieceWidth - offsetX * 2;
      var endY = (cell.row + 1) * this.PieceHeight - offsetY * 2;
      this.ctx.moveTo(beginX, beginY);
      this.ctx.lineTo(endX, endY); 
      this.ctx.moveTo(beginX, endY);
      this.ctx.lineTo(endX, beginY);   
      this.ctx.stroke();
      this.ctx.closePath(); 
    }
    this.putX = putX;

    function putO(cell){
      this.pieces[cell.col + cell.row*3] = "O";
      this.ctx.beginPath();
      this.ctx.strokeStyle = random_color('hex');
      this.ctx.lineWidth   = 4;
      var offsetX = this.PieceWidth * 0.1;
      var offsetY = this.PieceHeight * 0.1;
      var beginX = cell.col * this.PieceWidth + offsetX;
      var beginY = cell.row * this.PieceHeight + offsetY;
      var endX = (cell.col + 1) * this.PieceWidth - offsetX * 2;
      var endY = (cell.row + 1) * this.PieceHeight - offsetY * 2;
      this.ctx.arc(beginX + ((endX - beginX) / 2), beginY + ((endY - beginY) / 2), (endX - beginX) / 2 , 0, Math.PI * 2, true);
      this.ctx.stroke();
      this.ctx.closePath();
    }
    this.putO = putO;

    function put(index, player){
      var dm = divmod(index, 3);
      var cell = new Cell(dm[0], dm[1]);
      if (player === "O"){
        self.putO(cell);
      } else {
        self.putX(cell);
      }
    }
    this.put = put;

    function click(e){
      if (self.thinking){
        if (self.get_valid_moves().length > 0){
          alert('quit trying to cheat and let me think.');
          return;
        } else {
          alert("I'm pretty sure THAT's not legal.  How about we just start again?");
        }
      }
      if (self.game_over){
        alert('oh, should I have told you that I won?');
        self.restart();
        return;
      }
      cell = self.getCursorPosition(e);
      idx = cell.row*3 + cell.col;
      var valid_moves = self.get_valid_moves();
      if ($.inArray(idx, valid_moves) !== -1){
        self.putX(cell);
        self.move();
      }
    }
    self.click = click;

    function get_valid_moves(){
      var ret = [];
      for (var i=0; i<9; i++){
        if (self.pieces[i] === "") {
          ret.push(i);
        }
      }
      return ret;
    }
    self.get_valid_moves = get_valid_moves;

    function make_move(idx, player){
      self.pieces[idx] = player;
    }
    self.make_move = make_move;

    function undo_move(idx){
      self.pieces[idx] = "";
    }
    self.undo_move = undo_move;

    function row_wins(arr){
      var t = arr[0];
      for (var i=0; i< arr.length; i++){
        if (arr[i] === ""){ return false; }
        if (t !== arr[i]){ return false; }
      }
      return true;
    }

    function get_winner(){
      var winning_rows = [[0,1,2], [3,4,5], [6,7,8], [0,3,6], [1,4,7], [2,5,8], [0,4,8], [2,4,6]];
      for (var i=0; i<winning_rows.length; i++){
        var row = winning_rows[i];

        var arr = [self.pieces[row[0]], self.pieces[row[1]], self.pieces[row[2]]];

        if (row_wins(arr)){
          return arr[0];
        }
      }
      return "";
    }
    self.get_winner = get_winner;

    function playerindxs(){
      var ret = [];
      for (var i=0; i<self.pieces.length; i++){
        if (self.pieces[i] === self.player){
          ret.push(i);
        }
      }
      return ret;
    }
    self.playerindxs = playerindxs;

    function move(){
      self.thinking = true;
      self.$gofirst.hide();
      self.$restart.show();
      var valid_moves = self.get_valid_moves();

      // win if possible
      for (var i=0; i<valid_moves.length; i++){
        var idx = valid_moves[i];
        
        self.make_move(idx, self.computer);
        
        if (self.get_winner() === self.computer){
          //console.log("winner is computer");
          self.undo_move(idx);
          self.put(idx, self.computer);
          self.game_over = true;
          self.thinking = false;
          return;
        }
        self.undo_move(idx);
      }

      // don't let them win
      for (var i=0; i<valid_moves.length; i++){
        var idx = valid_moves[i];

        self.make_move(idx, self.player);

        if (self.get_winner() === self.player){
          self.undo_move(idx);
          self.put(idx, self.computer);
          self.thinking = false;
          return;
        }
        self.undo_move(idx);
      }

      // take the center
      if ($.inArray(4, valid_moves) !== -1){
        //console.log('taking the center');
        self.put(4, self.computer);
        self.thinking = false;
        return;
      }

      // grab a side if we are center and side is not opposite opponent
      var sides = [1,3,5,7];
      if (self.pieces[4] == self.computer){
        for (var i=0; i< sides.length; i++){
          if ($.inArray(sides[i], valid_moves) !== -1){
            if ($.inArray(8-sides[i], self.playerindxs().reversed()) === -1){
              //console.log('taking a side', sides[i]);
              self.put(sides[i], self.computer);
              self.thinking = false;
              return;
            }
          }
        }
      }

      // take a corner if not opposite
      var corners = [0,2,6,8];
      for (var i=0; i<corners.length; i++){
        if ($.inArray(corners[i], valid_moves) !== -1){
          //console.log('taking a corner');
          self.put(corners[i], self.computer);
          self.thinking = false;
          return;
        }
      }

      // just make a play, probably hopeless
      if (valid_moves.length > 1){
        self.put(valid_moves[0], self.computer);
        self.thinking = false;
        return;
      }
    }
    self.move = move;
    init();
  }
  api.TicTacToe = TicTacToe;
  return api;
}();
</script>


<script type="text/javascript">
$(function(){
  var can = $('<canvas id="TicTacToe"></canvas>');
  $('#app').append(can);
  var tictactoe = new ttt.TicTacToe('#TicTacToe');
});
</script>
</body>
